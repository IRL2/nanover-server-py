on: [push]
name: "Conda"

jobs:
  build-conda:
    name: Build packages
    runs-on: ubuntu-latest
    defaults:
      run:
        # This is necessary for the conda action. It replaces `conda init` as
        # the shell does not load ,profile or .bashrc.
        shell: bash -el {0}
    env:
      build_command: "conda-build --prefix-length=100 --no-test --no-anaconda-upload "
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # We need all the history to figure out the version number
      - uses: s-weigand/setup-conda@v1
      - name: Set environment variables
        run: |
          echo NANOVER_DOC_URL="https://irl2.github.io/nanover-docs/" >> "$GITHUB_ENV"
          echo NANOVER_REPO_URL="https://github.com/IRL2/nanover-server-py" >> "$GITHUB_ENV"
          echo NANOVER_BUILD_VERSION="0.1.$(git rev-list --count HEAD)" >> "$GITHUB_ENV"
          echo NANOVER_LICENSE_PATH="$(readlink -f LICENSE)" >> "$GITHUB_ENV"
          echo MIN_PYTHON_VERSION=3.11 >> "$GITHUB_ENV"
      - name: Test that the repo is sane and does not contain superfluous __init__ file
        run: bash ./maintainers/check_extra_init_files.sh
      - name: Install dependencies
        run: conda install -y python conda-build conda-verify
      - name: Building the Conda packages
        run: |
          $build_command python-libraries/nanover-server/conda
      - run: |
          mkdir artifacts
          cp -r ${CONDA_PREFIX}/conda-bld ./artifacts
          ls ./artifacts
      - name: Save the artifacts
        uses: actions/upload-artifact@v4
        with:
          name: conda-packages
          path: ./artifacts
  test-conda:
    name: Test package
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    continue-on-error: true
    needs: build-conda
    defaults:
      run:
        # This is necessary for the conda action. It replaces `conda init` as
        # the shell does not load ,profile or .bashrc.
        shell: bash -el {0}
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          miniforge-version: latest
      - name: Retrieve conda packages
        uses: actions/download-artifact@v4
        with:
          name: conda-packages
      - name: Install NanoVer
        run: conda install -y -c conda-forge -c ./conda-bld nanover-server
      - name: Install extra dependencies
        run: |
          pip install uv
          uv pip install -r ./python-libraries/nanover-server/pyproject.toml --all-extras
#      - name: All tests
#        run: python -m pytest python-libraries --timeout 60
      - name: Parallel tests
        run: python -m pytest python-libraries -n auto -m 'not serial' --timeout 60
      - name: Serial tests
        run: python -m pytest python-libraries -n 1 -m 'serial' --timeout 60
  publish-conda:
    name: Publish packages
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: test-conda
    defaults:
      run:
        # This is necessary for the conda action. It replaces `conda init` as
        # the shell does not load ,profile or .bashrc.
        shell: bash -el {0}
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          # WARNING! On the contrary to all the other places where we install
          # conda, we install miniconda and NOT miniforge!
          # This is because we do not need packages to RUN nanover, but packages
          # from the default (anaconda) channel to upload to anaconda.
          miniconda-version: latest
      - name: Retrieve conda packages
        uses: actions/download-artifact@v4
        with:
          name: conda-packages
      - name: Install Anaconda
        run: conda install -y anaconda-client
      - name: Connect to Anaconda cloud
        # The login token may be used by a failed build already. If we are asked
        # if we want it back, we say yes. Hence the echo Y.
        run: echo Y | anaconda login --username irl_bot --password ${{ secrets.ANACONDA_PASSWORD }}
      - name: Upload packages
        # Anaconda will complain if the given version of a package is already
        # there. Until we have some versioning, we force the upload.
        run: anaconda  upload --user irl conda-bld/noarch/nanover-*.conda --force
      - name: Disconnect from Anaconda cloud
        #  Do not fail the build if we cannot logout.
        run: anaconda logout || echo "Could not logout. Too bad."